# VRC Calendar Discord Bot - 使い方ガイド

DiscordでVRChatイベント（集会、ワールド紹介、アバター試着会など）を自然言語で管理できるBotです。OAuth 2.0でユーザーのGoogleカレンダーと連携し、コミュニティ全体で予定を共有できます。

## クイックスタート

### 基本コマンド

| コマンド | 説明 |
|---------|------|
| `/予定 [メッセージ]` | 予定の追加・編集・削除・検索 |
| `/今週の予定` | 今週の予定一覧を表示 |
| `/予定一覧` | 登録されている繰り返し予定の一覧 |
| `/ヘルプ` | Botの使い方を表示 |

### 管理コマンド

| コマンド | 説明 |
|---------|------|
| `/色一覧` `/色追加` `/色削除` | 色プリセットの管理 |
| `/タググループ一覧` `/タググループ追加` `/タググループ削除` | タググループの管理 |
| `/タグ追加` `/タグ削除` | タグの管理 |
| `/凡例更新` | 色/タグの凡例イベントを更新 |

### OAuth認証コマンド（manage_guild権限が必要）

| コマンド | 説明 |
|---------|------|
| `/カレンダー認証` | Google OAuth認証でカレンダーを連携（推奨） |
| `/カレンダー認証解除` | OAuth認証を解除 |
| `/カレンダー認証状態` | 現在の認証方式と状態を確認 |
| `/カレンダー設定` | 使用するカレンダーIDを変更 |

---

## 対話型予定登録（インタラクティブモード）

`/予定` コマンドで情報が不足している場合、Botはスレッドを作成してGemini AIとの対話で必要な情報を収集します。

### 対話フローの例

```
ユーザー: /予定 VRC集会を登録して

Bot: 💬 情報が不足しているため、対話モードで情報を収集します。
     スレッド「予定管理: VRC集会を登録して」をご確認ください。

(スレッド内)
Bot: VRC集会の登録を開始します！
     開催頻度を教えてください。
     - 毎週
     - 隔週
     - 第n週（例: 第2・第4週）
     - 不定期

     💡 「キャンセル」と入力するとセッションを終了できます。

ユーザー: 毎週です

Bot: 何曜日に開催しますか？

ユーザー: 土曜日

Bot: 開催時刻は何時ですか？

ユーザー: 21時から2時間

Bot: タグを設定しますか？
     利用可能なタグ:
     【ジャンル】集会 / ワールド紹介 / アバター交流
     【対象】初心者歓迎 / 上級者向け
     設定しない場合は「なし」と入力してください。

ユーザー: 集会と初心者歓迎

Bot: 色を設定しますか？
     利用可能な色: 赤(重要) / 青(集会) / 緑(初心者向け)
     設定しない場合は「なし」と入力してください。

ユーザー: 青

Bot: (確認Embed表示)
     ┌────────────────────────────┐
     │ 予定追加の確認              │
     │                            │
     │ 予定名: VRC集会             │
     │ 繰り返し: 毎週 土曜日       │
     │ 時刻: 21:00                │
     │ 所要時間: 120分            │
     │ タグ: 集会, 初心者歓迎      │
     │ 色: 青                     │
     │                            │
     │ [確定] [キャンセル]         │
     └────────────────────────────┘

ユーザー: (確定ボタンを押す)

Bot: ✅ 予定を登録しました！
     📅 VRC集会
     🔄 毎週
     ⏰ 21:00
     📌 次回: 2026-02-08
     (スレッドをアーカイブ)
```

### 対話モードの特徴

- **自動スレッド作成**: 対話はスレッド内で行われ、チャンネルを汚しません
- **タイムアウト**: 5分間操作がないとセッションが自動終了します
- **キャンセル**: 「キャンセル」「やめる」と入力するといつでも中断できます
- **サーバー設定の反映**: 登録済みのタグ・色プリセットが選択肢として表示されます

### 完全な入力の場合

必要な情報がすべて揃っている場合は、スレッドを作成せずに即座に確認ダイアログが表示されます。

```
ユーザー: /予定 毎週土曜21時にVRC集会を追加、タグは集会、色は青

Bot: (確認Embed表示)
     [確定] [キャンセル]
```

---

## Googleカレンダーとの連携

### OAuth認証（推奨）

OAuth 2.0を使って、ユーザー自身のGoogleカレンダーに直接アクセスします。

#### 初回セットアップ

1. **サーバー管理者**が `/カレンダー認証` を実行します
2. Bot が認証URLを含むメッセージ（あなただけに見える）を送信します
3. 認証URLのリンクをクリックしてブラウザで開きます
4. Googleアカウントでログインし、カレンダーへのアクセスを許可します
5. ブラウザに「認証成功」と表示されれば完了です
6. Discordに戻り、予定の管理を開始できます

> **注意**: 認証URLは一度だけ使用できます。期限切れや再認証が必要な場合は、再度 `/カレンダー認証` を実行してください。

#### 認証状態の確認

```
/カレンダー認証状態
```

以下の情報が表示されます:
- **認証方式**: OAuth 2.0
- **認証者**: 認証を行ったDiscordユーザー
- **認証日時**: 認証が行われた日時
- **カレンダーID**: 連携先のカレンダーID

#### 認証の解除

```
/カレンダー認証解除
```

---

## 予定の追加

予定を追加する際は、**繰り返しパターン**、**曜日**、**時刻** を含めてください。情報が不足している場合は対話モードで収集されます。

### 毎週の予定

```
/予定 毎週土曜日の21時にVRC集会を追加
```

```
/予定 毎週金曜22時からワールド紹介会
```

### 隔週の予定

```
/予定 隔週日曜20時にアバター試着会を追加
```

### 第n週の予定

```
/予定 第2・第4土曜日の21時にVRC定例集会を追加
```

```
/予定 第1金曜日の22時に月初イベント
```

### タグ付きの予定

タグを付けると予定を分類でき、検索が便利になります。タグは事前に `/タグ追加` で登録しておく必要があります。

```
/予定 毎週土曜21時にVRC集会、タグは集会
```

```
/予定 第3日曜20時に初心者歓迎会、タグは初心者歓迎、集会
```

### 所要時間の指定

デフォルトの所要時間は60分です。変更する場合は明示的に指定してください。

```
/予定 毎週土曜21時にVRC集会、2時間
```

```
/予定 隔週金曜22時にワールド紹介会、3時間
```

### 色の指定

色プリセットが登録されている場合、予定に色を設定できます。

```
/予定 毎週土曜21時にVRC集会を追加、色は集会
```

### URL付きの予定

```
/予定 毎週土曜21時にVRC集会、URLはhttps://vrchat.com/home/world/wrld_xxxxx
```

---

## 予定の検索

### 今週の予定を確認

```
/今週の予定
```

または

```
/予定 今週の予定を教えて
```

### 来週の予定を確認

```
/予定 来週の予定は？
```

### 今日の予定

```
/予定 今日の予定を確認
```

### 今月の予定

```
/予定 今月の予定を表示
```

### タグで検索

```
/予定 集会の予定を検索
```

```
/予定 初心者歓迎の予定を表示
```

### 名前で検索

予定名は部分一致で検索されます。

```
/予定 VRC集会の予定を探して
```

---

## 予定の編集

編集コマンドを実行すると、対象の予定が表示され、確認ダイアログが表示されます。

### 時刻の変更

```
/予定 VRC集会を22時に変更
```

### 説明の追加

```
/予定 VRC集会の説明を「毎週開催の定例集会」に更新
```

> **注意**: 同名の予定が複数ある場合は、最初に見つかった予定が対象になります。

---

## 予定の削除

削除コマンドを実行すると、対象の予定が表示され、確認ダイアログが表示されます。「確定」を押すと削除されます（論理削除）。Googleカレンダーからも同時に削除されます。

```
/予定 VRC集会を削除
```

```
/予定 ワールド紹介会をキャンセル
```

> **注意**: 同名の予定が複数ある場合は、最初に見つかった予定が対象になります。

---

## 自然言語の例

Botは様々な日本語表現を理解します。Gemini APIによる自然言語処理を使用しているため、多様な言い回しに対応しています。

### 追加の表現

- 「〜を追加」
- 「〜を登録」
- 「〜を作成」
- 「〜を入れて」
- 「〜があります」

### 検索の表現

- 「〜を教えて」
- 「〜を確認」
- 「〜を表示」
- 「〜は？」
- 「〜を検索」
- 「〜を探して」

### 削除の表現

- 「〜を削除」
- 「〜をキャンセル」
- 「〜を取り消し」
- 「〜をなくして」

### 編集の表現

- 「〜を変更」
- 「〜を更新」
- 「〜を修正」
- 「〜に変えて」

---

## 繰り返しパターン

### 毎週

毎週同じ曜日に繰り返す予定。

```
毎週土曜日 → 毎週土曜日に予定を作成
```

### 隔週

2週間に1回繰り返す予定。

```
隔週金曜日 → 2週間ごとの金曜日に予定を作成
```

### 第n週

毎月特定の週のみに繰り返す予定。複数の週を指定することもできます。

```
第2土曜日 → 毎月第2週の土曜日のみ
第2・第4土曜日 → 毎月第2週と第4週の土曜日
第1・第3金曜日 → 毎月第1週と第3週の金曜日
```

### 不定期

繰り返しパターンが決まっていない予定。個別に日時を追加します。

---

## 週次通知

毎週月曜日の朝9時（JST）に、その週の予定一覧が自動的に各チャンネルに投稿されます。通知は、予定が登録されたチャンネルに送信されます。

通知例：
```
🔔 今週の予定通知

📅 今週の予定
──────────────
02/08 (土)
⏰ 21:00 - VRC集会 [集会, 初心者歓迎]

02/09 (日)
⏰ 20:00 - アバター試着会

予定の追加・管理は /予定 コマンドから
```

---

## タグの活用

タグを使うと予定を分類でき、検索や表示が便利になります。

### タググループの管理

タグはグループで管理されます（サーバーごとに最大3グループ）。

#### VRChatイベント向けのタグ例

**ジャンル系タグ**:
- 集会
- ワールド紹介
- アバター交流
- 技術系
- 音楽系

**対象者系タグ**:
- 初心者歓迎
- 上級者向け
- 誰でも参加OK

**頻度系タグ**:
- 定例
- 不定期
- 特別イベント

#### タググループの追加

```
/タググループ追加 名前:ジャンル 説明:イベントのジャンル
```

#### タグの追加

```
/タグ追加 group_id:1 名前:集会 説明:VRChat集会イベント
```

---

## 色の管理

Googleカレンダーの予定に色を付けることができます。

### VRChatイベント向けの色プリセット例

| 色名 | 色ID | 用途 |
|------|------|------|
| 集会 | 9 | 青 - 定例集会 |
| 初心者向け | 2 | 緑 - 初心者歓迎イベント |
| 特別 | 11 | 赤 - 特別イベント |
| ワールド | 7 | 水色 - ワールド紹介 |

#### 色プリセットの追加

```
/色追加 名前:集会 color_id:9 説明:定例集会用
```

---

## トラブルシューティング

### コマンドが認識されない

Botが起動中の場合、スラッシュコマンドの同期に数秒かかることがあります。少し待ってから再試行してください。

### 「曜日を特定できませんでした」エラー

予定を追加する際は、曜日を明確に指定してください。または対話モードで情報を入力してください。

- ❌ `21時にVRC集会を追加`
- ⭕ `毎週土曜21時にVRC集会を追加`

### 対話モードがタイムアウトした

5分間操作がないとセッションが自動終了します。もう一度 `/予定` コマンドを実行してください。

### 予定が見つからない

予定名は部分一致で検索されます。正確な名前がわからない場合は、一部のキーワードで検索してください。

```
/予定 集会の予定を検索
```

### OAuth認証でエラーが出る

- **「redirect_uri_mismatch」**: GCPコンソールの承認済みURIと環境変数 `OAUTH_REDIRECT_URI` が完全一致しているか確認してください
- **「access_denied」**: OAuth同意画面でテストユーザーにGoogleアカウントを追加してください
- **認証後にカレンダー操作エラー**: `/カレンダー認証` で再認証してください

### カレンダー認証コマンドが使えない

`/カレンダー認証` `/カレンダー認証解除` `/カレンダー認証状態` は `manage_guild`（サーバー管理）権限が必要です。サーバーの管理者に依頼してください。

---

## コマンドのヒント

1. **自然に話しかける**: 「〜して」「〜教えて」など、普段の会話のように入力できます

2. **情報が足りなくても大丈夫**: 不足情報は対話モードで補完されます

3. **曖昧な表現を避ける**: 日時は具体的に指定すると正確に処理されます

4. **エラー時は言い換え**: 認識されない場合は、別の表現で試してみてください

5. **確認ダイアログ**: 予定の追加・編集・削除では必ず確認ダイアログが表示されます。内容を確認してから「確定」を押してください

---

## フィードバック

Botの改善提案やバグ報告は、プロジェクトのIssueで受け付けています。
