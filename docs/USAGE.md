# VRC Calendar Discord Bot - 使い方ガイド

Discordで自然言語を使って予定を管理できるBotです。OAuth 2.0でユーザーのGoogleカレンダーと連携し、チーム全体で予定を共有できます。

## クイックスタート

### 基本コマンド

| コマンド | 説明 |
|---------|------|
| `/予定 [メッセージ]` | 予定の追加・編集・削除・検索 |
| `/今週の予定` | 今週の予定一覧を表示 |
| `/予定一覧` | 登録されている繰り返し予定の一覧 |
| `/ヘルプ` | Botの使い方を表示 |

### 管理コマンド

| コマンド | 説明 |
|---------|------|
| `/色一覧` `/色追加` `/色削除` | 色プリセットの管理 |
| `/タググループ一覧` `/タググループ追加` `/タググループ削除` | タググループの管理 |
| `/タグ追加` `/タグ削除` | タグの管理 |
| `/カレンダー一覧` `/カレンダー追加` `/カレンダー使用` | カレンダーアカウントの管理（サービスアカウント方式） |
| `/凡例更新` | 色/タグの凡例イベントを更新 |

### OAuth認証コマンド（manage_guild権限が必要）

| コマンド | 説明 |
|---------|------|
| `/カレンダー認証` | Google OAuth認証でカレンダーを連携（推奨） |
| `/カレンダー認証解除` | OAuth認証を解除（サービスアカウントにフォールバック） |
| `/カレンダー認証状態` | 現在の認証方式と状態を確認 |

---

## Googleカレンダーとの連携

### OAuth認証（推奨）

OAuth 2.0を使って、ユーザー自身のGoogleカレンダーに直接アクセスします。サービスアカウントへのカレンダー共有設定は不要です。

#### 初回セットアップ

1. **サーバー管理者**が `/カレンダー認証` を実行します
2. Bot が認証URLを含むメッセージ（あなただけに見える）を送信します
3. 認証URLのリンクをクリックしてブラウザで開きます
4. Googleアカウントでログインし、カレンダーへのアクセスを許可します
5. ブラウザに「認証成功」と表示されれば完了です
6. Discordに戻り、予定の管理を開始できます

> **注意**: 認証URLは一度だけ使用できます。期限切れや再認証が必要な場合は、再度 `/カレンダー認証` を実行してください。

#### 認証状態の確認

```
/カレンダー認証状態
```

以下の情報が表示されます:
- **認証方式**: OAuth 2.0 / サービスアカウント / デフォルト
- **認証者**: 認証を行ったDiscordユーザー
- **認証日時**: 認証が行われた日時
- **カレンダーID**: 連携先のカレンダーID

#### 認証の解除

```
/カレンダー認証解除
```

OAuth認証を解除すると、サービスアカウント方式にフォールバックします。サービスアカウントも設定されていない場合はデフォルトのサービスアカウントが使用されます。

#### 認証の優先順位

Bot は以下の優先順位でカレンダーにアクセスします:

1. **OAuth トークン**（`/カレンダー認証` で設定） - ユーザーのGoogleアカウントで直接アクセス
2. **サービスアカウント**（`/カレンダー使用` で設定） - サービスアカウント経由でアクセス
3. **デフォルト**（環境変数のサービスアカウント）

OAuth トークンが失効した場合（Googleアカウント側でアクセスを取り消した場合など）は、自動的にサービスアカウントにフォールバックします。

### サービスアカウント方式（従来方式）

サービスアカウントを使ってカレンダーにアクセスする方法です。カレンダーの共有設定でサービスアカウントに編集権限を付与する必要があります。

```
/カレンダー追加 名前:メイン calendar_id:abc123@group.calendar.google.com
/カレンダー使用 id:1
```

---

## 予定の追加

予定を追加する際は、必ず **繰り返しパターン**、**曜日**、**時刻** を含めてください。確認ダイアログが表示され、「確定」を押すと登録されます。

### 毎週の予定

```
/予定 毎週水曜日の14時に定例会議を追加
```

```
/予定 毎週金曜20時からチームミーティング
```

### 隔週の予定

```
/予定 隔週月曜10時に1on1ミーティングを追加
```

### 第n週の予定

```
/予定 第2・第4水曜日の14時に定例MTGを追加
```

```
/予定 第1金曜日の19時に月初会議
```

### タグ付きの予定

タグを付けると予定を分類でき、検索が便利になります。タグは事前に `/タグ追加` で登録しておく必要があります。

```
/予定 毎週火曜15時にチームミーティング、タグは重要
```

```
/予定 第3木曜20時に勉強会、タグはチームミーティング、個人
```

### 所要時間の指定

デフォルトの所要時間は60分です。変更する場合は明示的に指定してください。

```
/予定 毎週水曜14時に定例会議、2時間
```

```
/予定 隔週金曜19時にゲーム会、3時間
```

### 色の指定

色プリセットが登録されている場合、予定に色を設定できます。

```
/予定 毎週水曜14時に定例会議を追加、色は重要
```

### URL付きの予定

```
/予定 毎週土曜21時にゲーム配信、URLはhttps://example.com
```

---

## 予定の検索

### 今週の予定を確認

```
/今週の予定
```

または

```
/予定 今週の予定を教えて
```

### 来週の予定を確認

```
/予定 来週の予定は？
```

### 今日の予定

```
/予定 今日の予定を確認
```

### 今月の予定

```
/予定 今月の予定を表示
```

### タグで検索

```
/予定 チームミーティングの予定を検索
```

```
/予定 重要な予定を表示
```

### 名前で検索

予定名は部分一致で検索されます。正確な名前がわからない場合でも、一部のキーワードで検索できます。

```
/予定 定例会議の予定を探して
```

```
/予定 会議の予定を検索
```

---

## 予定の編集

編集コマンドを実行すると、対象の予定が表示され、確認ダイアログが表示されます。

### 時刻の変更

```
/予定 定例会議を15時に変更
```

### 説明の追加

```
/予定 定例会議の説明を「進捗確認」に更新
```

> **注意**: 同名の予定が複数ある場合は、最初に見つかった予定が対象になります。

---

## 予定の削除

削除コマンドを実行すると、対象の予定が表示され、確認ダイアログが表示されます。「確定」を押すと削除されます（論理削除）。Googleカレンダーからも同時に削除されます。

```
/予定 定例会議を削除
```

```
/予定 勉強会をキャンセル
```

> **注意**: 同名の予定が複数ある場合は、最初に見つかった予定が対象になります。

---

## 自然言語の例

Botは様々な日本語表現を理解します。Gemini APIによる自然言語処理を使用しているため、多様な言い回しに対応しています。

### 追加の表現

- 「〜を追加」
- 「〜を登録」
- 「〜を作成」
- 「〜を入れて」
- 「〜があります」

### 検索の表現

- 「〜を教えて」
- 「〜を確認」
- 「〜を表示」
- 「〜は？」
- 「〜を検索」
- 「〜を探して」

### 削除の表現

- 「〜を削除」
- 「〜をキャンセル」
- 「〜を取り消し」
- 「〜をなくして」

### 編集の表現

- 「〜を変更」
- 「〜を更新」
- 「〜を修正」
- 「〜に変えて」

---

## 繰り返しパターン

### 毎週

毎週同じ曜日に繰り返す予定。

```
毎週水曜日 → 毎週水曜日に予定を作成
```

### 隔週

2週間に1回繰り返す予定。

```
隔週金曜日 → 2週間ごとの金曜日に予定を作成
```

### 第n週

毎月特定の週のみに繰り返す予定。複数の週を指定することもできます。

```
第2水曜日 → 毎月第2週の水曜日のみ
第2・第4水曜日 → 毎月第2週と第4週の水曜日
第1・第3金曜日 → 毎月第1週と第3週の金曜日
```

### 不定期

繰り返しパターンが決まっていない予定。個別に日時を追加します。

---

## 週次通知

毎週月曜日の朝9時（JST）に、その週の予定一覧が自動的に各チャンネルに投稿されます。通知は、予定が登録されたチャンネルに送信されます。

通知例：
```
🔔 今週の予定通知

📅 今週の予定
──────────────
01/27 (月)
⏰ 10:00 - 1on1ミーティング

01/29 (水)
⏰ 14:00 - 定例会議 [チームミーティング]

01/31 (金)
⏰ 20:00 - ゲーム会

予定の追加・管理は /予定 コマンドから
```

> 週次通知は OCI VM 上の cron ジョブ、または Cloud Scheduler + Pub/Sub で設定します。
> 詳しくは [デプロイガイド](DEPLOY.md) を参照してください。

---

## タグの活用

タグを使うと予定を分類でき、検索や表示が便利になります。

### タググループの管理

タグはグループで管理されます（サーバーごとに最大3グループ）。

#### タググループの一覧表示

```
/タググループ一覧
```

登録されているタググループとそれぞれに属するタグが一覧表示されます。

#### タググループの追加

```
/タググループ追加 名前:カテゴリ 説明:予定のカテゴリ
```

グループ名と説明を指定して追加します。最大3グループまで作成できます。

#### タググループの削除

```
/タググループ削除 id:1
```

グループIDを指定して削除します。グループに属するタグもすべて削除されます。

#### タグの追加

```
/タグ追加 group_id:1 名前:重要 説明:優先度の高い予定
```

指定したグループにタグを追加します。予定追加時に使用するタグは事前に登録が必要です。

#### タグの削除

```
/タグ削除 group_id:1 名前:重要
```

指定したグループからタグを削除します。

### よく使うタグ例

| タグ | 用途 | Googleカレンダーでの色 |
|------|------|----------------------|
| 重要 | 優先度の高い予定 | 赤 |
| チームミーティング | チーム全体の会議 | 青 |
| 個人 | 個人的な予定 | 緑 |

### タグで検索

```
/予定 重要タグの予定を検索
```

---

## 色の管理

Googleカレンダーの予定に色を付けることができます。

### 色プリセットの管理

#### 色一覧の表示

```
/色一覧
```

登録済みの色プリセットと、GoogleカレンダーのカラーID一覧が表示されます。

#### 色プリセットの追加

```
/色追加 名前:重要 color_id:11 説明:赤色で表示
```

色名、GoogleカレンダーのカラーID、説明を指定して追加します。

#### 色プリセットの削除

```
/色削除 名前:重要
```

### GoogleカレンダーのカラーID

| ID | 色 |
|----|-----|
| 1 | ラベンダー |
| 2 | セージ |
| 3 | ブドウ |
| 4 | フラミンゴ |
| 5 | バナナ |
| 6 | ミカン |
| 7 | ピーコック |
| 8 | グラファイト |
| 9 | ブルーベリー |
| 10 | バジル |
| 11 | トマト |

### 予定に色を設定

```
/予定 毎週水曜14時に定例会議を追加、色は重要
```

色プリセットの名前を指定します。未登録の色名を指定するとエラーになります。

---

## 凡例イベント

Googleカレンダー上に、登録済みの色プリセットとタグの一覧を表示する凡例イベントを作成できます。色やタグを追加・削除すると自動的に更新されます。

```
/凡例更新
```

手動で凡例を更新する場合に実行します。`/色追加` `/色削除` `/タグ追加` `/タグ削除` `/タググループ追加` `/タググループ削除` 実行時にも自動で更新されます。

---

## トラブルシューティング

### コマンドが認識されない

Botが起動中の場合、スラッシュコマンドの同期に数秒かかることがあります。少し待ってから再試行してください。スラッシュコマンドが表示されない場合は、Botを再起動するか1時間待ってください。

### 「曜日を特定できませんでした」エラー

予定を追加する際は、曜日を明確に指定してください。

- ❌ `14時に会議を追加`
- ⭕ `毎週水曜14時に会議を追加`

### 予定が見つからない

予定名は部分一致で検索されます。正確な名前がわからない場合は、一部のキーワードで検索してください。

```
/予定 会議の予定を検索
```

### 予定が重複する

同じ予定を複数回追加すると、重複して登録されます。削除してから再登録するか、編集コマンドを使用してください。

### OAuth認証でエラーが出る

- **「redirect_uri_mismatch」**: GCPコンソールの承認済みURIと環境変数 `OAUTH_REDIRECT_URI` が完全一致しているか確認してください
- **「access_denied」**: OAuth同意画面でテストユーザーにGoogleアカウントを追加してください
- **認証後にカレンダー操作エラー**: `/カレンダー認証` で再認証してください。Google側でアクセスを取り消していないかも確認してください

### カレンダー認証コマンドが使えない

`/カレンダー認証` `/カレンダー認証解除` `/カレンダー認証状態` は `manage_guild`（サーバー管理）権限が必要です。サーバーの管理者に依頼してください。

### OAuth未設定のメッセージが表示される

Bot側でOAuth環境変数（`GOOGLE_OAUTH_CLIENT_ID`, `GOOGLE_OAUTH_CLIENT_SECRET`, `OAUTH_REDIRECT_URI`）が設定されていません。Bot管理者に連絡してください。

---

## コマンドのヒント

1. **自然に話しかける**: 「〜して」「〜教えて」など、普段の会話のように入力できます

2. **曖昧な表現を避ける**: 日時は具体的に指定すると正確に処理されます

3. **エラー時は言い換え**: 認識されない場合は、別の表現で試してみてください

4. **一度に1つの操作**: 複数の操作を同時に行う場合は、分けて入力してください

5. **確認ダイアログ**: 予定の追加・編集・削除では必ず確認ダイアログが表示されます。内容を確認してから「確定」を押してください

---

## フィードバック

Botの改善提案やバグ報告は、プロジェクトのIssueで受け付けています。
